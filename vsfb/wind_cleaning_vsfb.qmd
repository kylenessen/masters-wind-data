---
title: "Wind Data Cleaning VSFB"
author: "Kyle Nessen"
date: "2025-03-19"
format:
    html:
        theme: cosmo
        code-fold: true
        toc: true
        toc-depth: 3
        number-sections: true
execute:
    echo: true
    warning: false
    message: false
---

## Overview

This document processes wind data from the VSFB Camera Study. We'll load the deployment information, match it with the raw wind data files, and produce a cleaned dataset.

```{r setup}
library(tidyverse)
library(RSQLite)

# Source the helper functions
source("../scripts/load_vsfb_data.R")
source("../scripts/inspect_sqlite.R")
```

## Database Inspection

First, let's inspect one of the SQLite database files to understand its structure:

```{r inspect-db}
# Inspect a sample database file
sample_file <- "../raw_data/BlueLake.s3db"
db_info <- inspect_sqlite_db(sample_file)

# List the tables found
cat("Tables found in the database:", names(db_info), "\n")
```

## Loading Deployment Information and Wind Data

Now that we understand the database structure, we can load the wind data from all relevant files:

```{r load-data}
# Path to deployments file
deployments_path <- "deployments2023.csv"

# Load all wind data matching the wind meter names in the deployments file
df <- load_vsfb_wind_data(deployments_path, "../raw_data")

# Display the first few rows and structure of the data
if (nrow(df) > 0) {
  head(df)
  glimpse(df)
  cat("Total records:", nrow(df), "\n")
  cat("Wind meters included:", paste(unique(df$wind_meter_name), collapse = ", "), "\n")
} else {
  cat("No data was loaded. Check the console for warnings.\n")
}
```

## Data Summary

Let's examine the loaded data to understand what we're working with:

```{r data-summary, eval=nrow(exists("df") && df) > 0}
# Check time range in the data
if (exists("df") && nrow(df) > 0) {
  time_summary <- df %>%
    summarize(
      earliest = min(time, na.rm = TRUE),
      latest = max(time, na.rm = TRUE),
      total_records = n()
    )
  
  print(time_summary)
  
  # Check wind measurements by meter
  wind_summary <- df %>%
    group_by(wind_meter_name) %>%
    summarize(
      records = n(),
      avg_speed = mean(speed, na.rm = TRUE),
      max_speed = max(speed, na.rm = TRUE),
      avg_gust = mean(gust, na.rm = TRUE),
      max_gust = max(gust, na.rm = TRUE)
    )
  
  print(wind_summary)
}
```